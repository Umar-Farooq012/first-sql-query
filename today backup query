WITH DETAIL AS (
    SELECT 
        SPR.POLICY_IDS,
        SPR.POLICY_TYPE,
        SPR.ITEM_ID,
        SPR.RATIO,
        SUM(SPR.NO_TONS)          AS TOTAL_NO_TONS,
        SUM(SPR.NO_BAGS)          AS TOTAL_NO_BAGS,
        SUM(SPR.RATE)             AS TOTAL_RATE,
        SUM(SPR.MARKET_RATE)      AS TOTAL_MARKET_RATE,
        SUM(SPR.PROFIT_LOSS)      AS TOTAL_PROFIT_LOSS,
        NVL(SUM(SPR.ADDITIONAL_RATIO),0) AS TOTAL_ADDITIONAL_RATIO,
        ITM.ITEM_NAME
    FROM 
        AB_SETUP_POLICY_REGISTERED SPR
        JOIN AB_ITEMS_MASTER ITM ON ITM.ITEM_ID = SPR.ITEM_ID
    WHERE 
        SPR.ORG_ID      = NVL(:GV_ORG_ID, SPR.ORG_ID)
          AND SPR.POLICY_TYPE = 'CLUB PRODUCT'
       -- AND SPR.POLICY_TYPE = 'ACTUAL PRODUCT'
        AND SPR.POLICY_IDS  = NVL(:GV_POLICY_ID, SPR.POLICY_IDS)
        AND SPR.STATUS = 'Y'
    GROUP BY 
        SPR.POLICY_IDS,
        SPR.POLICY_TYPE,
        SPR.ITEM_ID,
        ITM.ITEM_NAME,
        SPR.RATIO,
        SPR.NO_BAGS
),
MASTER_SPR AS (
    SELECT 
        SPPR.POLICY_ID,
        SPPR.POLICY_TYPE,
        SPPR.POLICY_NAME,
        SPPR.POLICY_CODE,
        TO_CHAR(SPPR.POLICY_EFFECTIVE_SD,'DD-MON-YYYY') AS DEAL_DATE,
        TO_CHAR(SPPR.POLICY_EFFECTIVE_SD, 'MONTH') AS D_MONTH,
        DTL.POLICY_TYPE AS DETAIL_POLICY_TYPE,
        DTL.ITEM_ID,
        DTL.ITEM_NAME,
        DTL.RATIO,
        DTL.TOTAL_NO_TONS,
        DTL.TOTAL_NO_BAGS,
        DTL.TOTAL_RATE,
        DTL.TOTAL_MARKET_RATE,
        DTL.TOTAL_PROFIT_LOSS,
        DTL.TOTAL_ADDITIONAL_RATIO
    FROM   
        AB_SETUP_POLICY_REGISTERED SPPR
        JOIN DETAIL DTL ON DTL.POLICY_IDS = SPPR.POLICY_ID
    WHERE 
        SPPR.POLICY_TYPE = 'PURCHASE DEAL'
        AND SPPR.STATUS = 'Y'
),
SETUP_REGISTRATION AS (
     SELECT 
        SPR.POLICY_IDS,
          MAX(CASE WHEN REG.REG_TYPE = 'AGENCY' AND REG.SR_ID = SPR.AGENCY_ID THEN REG.REG_NAME || ' - ' || REG.REG_CODE 
            ELSE NULL 
            END) AS AGENCY_NAME,
        MAX(CASE WHEN (REG.REG_TYPE = 'DEALER' OR REG.REG_TYPE = 'VENDOR') AND REG.SR_ID = SPR.SUPPLIER_ID THEN REG.PARTY_NAME 
            ELSE NULL 
            END) AS VENDOR_NAME
    FROM 
          AB_SETUP_POLICY_REGISTERED SPR
    JOIN  AB_SETUP_REGISTRATION REG ON REG.SR_ID IN (SPR.SUPPLIER_ID, SPR.AGENCY_ID)
    WHERE 
           SPR.ORG_ID      = NVL(:GV_ORG_ID, SPR.ORG_ID)
          AND SPR.POLICY_TYPE = 'CLUB PRODUCT'
       -- AND SPR.POLICY_TYPE = 'ACTUAL PRODUCT'
        AND SPR.POLICY_IDS  = NVL(:GV_POLICY_ID, SPR.POLICY_IDS)
    GROUP BY 
            SPR.POLICY_IDS
),
PURCHASE_ORDER AS (
    SELECT 
        PO.PO_ID,
        POD.DEAL_POLICY_ID,
        DRD.ITEM_ID,
        SUM(POD.CHANGE_BAGS) AS TOTAL_BAGS
    FROM
        AB_PO_PURCHASE_ORDER PO
        JOIN AB_PO_PURCHASE_ORDER_DET POD ON POD.PO_ID = PO.PO_ID
        JOIN AB_PO_DEMAND_REQ_DET DRD ON DRD.DET_ID = POD.DEMAND_DET_ID
       -- JOIN DETAIL DTL ON DTL.POLICY_IDS = POD.DEAL_POLICY_ID AND DTL.ITEM_ID = DRD.ITEM_ID
    WHERE 
        PO.ORG_ID = NVL(:GV_ORG_ID, PO.ORG_ID)
        AND PO.PO_TYPE = 'PURCHASE ORDER'
        AND PO.STATUS = 'Y'
        AND POD.STATUS ='Y'
        AND DRD.STATUS = 'Y'
    GROUP BY 
        PO.PO_ID,
        --POD.CHANGE_BAGS,
        POD.DEAL_POLICY_ID,
        DRD.ITEM_ID
),
PURCHASE_INVOICE AS (
    SELECT 
        INV.PO_ID,
        INV.IDS,
        SUM(INVD.CHANGE_BAGS) AS INVOICE_BAGS
    FROM 
        AB_PO_PURCHASE_ORDER INV
        JOIN AB_PO_PURCHASE_ORDER_DET INVD ON INVD.PO_ID = INV.PO_ID
       -- JOIN PURCHASE_ORDER PO ON PO.PO_ID = INV.IDS
    WHERE 
        INV.ORG_ID = NVL(:GV_ORG_ID, INV.ORG_ID)
        AND INV.PO_TYPE = 'PURCHASE INVOICE'
        AND INV.STATUS ='Y'
        AND INVD.STATUS = 'Y'
    GROUP BY
        INV.PO_ID,
        INV.IDS
)
-- Final Query
SELECT *
FROM (
    -- Scenario 1: ITEM_ID matches, use INNER JOIN
    SELECT 
        DTL.POLICY_IDS,
        DTL.POLICY_TYPE,
        DTL.ITEM_ID,
        DTL.ITEM_NAME,
        REG.VENDOR_NAME,
        REG.AGENCY_NAME,
        DTL.RATIO,
        MSPR.D_MONTH,
        MSPR.DEAL_DATE,
        DTL.TOTAL_ADDITIONAL_RATIO,
        DTL.TOTAL_NO_BAGS                                      AS AS_PER_RATIO,
        NVL(SUM(PO.TOTAL_BAGS), 0)                             AS OG,
        (DTL.TOTAL_NO_BAGS) - NVL(SUM(PO.TOTAL_BAGS), 0)       AS BALANCE_RATIO,
        NVL(SUM(INV.INVOICE_BAGS), 0)                          AS RECEIVED,
        NVL(SUM(PO.TOTAL_BAGS) - SUM(INV.INVOICE_BAGS), 0)     AS TOTAL_BALANCE,
        MAX(MSPR.POLICY_NAME)                                  AS POLICY_NAME,
        MAX(MSPR.POLICY_CODE)                                  AS POLICY_CODE
    FROM 
        DETAIL DTL
    JOIN MASTER_SPR MSPR ON  MSPR.POLICY_ID =DTL.POLICY_IDS 
    JOIN PURCHASE_ORDER PO ON PO.DEAL_POLICY_ID= DTL.POLICY_IDS AND PO.ITEM_ID = DTL.ITEM_ID  
    JOIN PURCHASE_INVOICE INV ON INV.IDS = PO.PO_ID
    JOIN SETUP_REGISTRATION REG ON REG.POLICY_IDS = DTL.POLICY_IDS

    GROUP BY 
        DTL.POLICY_IDS,
        DTL.POLICY_TYPE,
        DTL.ITEM_ID,
        DTL.RATIO,
        DTL.ITEM_NAME,
        MSPR.D_MONTH,
        DTL.TOTAL_NO_BAGS,
        MSPR.POLICY_CODE,
        REG.VENDOR_NAME,
        REG.AGENCY_NAME,
        DTL.TOTAL_ADDITIONAL_RATIO,
        MSPR.DEAL_DATE

    UNION ALL

    -- Scenario 2: ITEM_ID does not match, use LEFT JOIN
    SELECT 
        DTL.POLICY_IDS,
        DTL.POLICY_TYPE,
        DTL.ITEM_ID,
        DTL.ITEM_NAME,
        REG.VENDOR_NAME,
        REG.AGENCY_NAME,
        DTL.RATIO,
        MSPR.D_MONTH,
        MSPR.DEAL_DATE,
        DTL.TOTAL_ADDITIONAL_RATIO,
        DTL.TOTAL_NO_BAGS                                  AS AS_PER_RATIO,
        NVL(SUM(PO.TOTAL_BAGS), 0)                         AS OG,
        (DTL.TOTAL_NO_BAGS - NVL(SUM(PO.TOTAL_BAGS), 0))   AS BALANCE_RATIO,
        NVL(SUM(INV.INVOICE_BAGS), 0)                      AS RECEIVED,
        NVL(SUM(PO.TOTAL_BAGS) - SUM(INV.INVOICE_BAGS), 0) AS TOTAL_BALANCE,
        MAX(MSPR.POLICY_NAME)                              AS POLICY_NAME,
        MAX(MSPR.POLICY_CODE)                              AS POLICY_CODE
    FROM 
        DETAIL DTL
    JOIN MASTER_SPR MSPR ON  MSPR.POLICY_ID = DTL.POLICY_IDS 
    LEFT JOIN PURCHASE_ORDER PO ON PO.DEAL_POLICY_ID = DTL.POLICY_IDS --AND PO.ITEM_ID <>  DTL.ITEM_ID 
    LEFT JOIN PURCHASE_INVOICE INV ON INV.IDS = PO.PO_ID
        JOIN SETUP_REGISTRATION REG ON REG.POLICY_IDS = DTL.POLICY_IDS

    WHERE NOT EXISTS (
        SELECT 1
        FROM PURCHASE_ORDER PO_MATCH
        WHERE 
        PO_MATCH.DEAL_POLICY_ID = DTL.POLICY_IDS
        AND 
        PO_MATCH.ITEM_ID = DTL.ITEM_ID
    )
    GROUP BY 
        DTL.POLICY_IDS,
        DTL.POLICY_TYPE,
        DTL.ITEM_ID,
        REG.VENDOR_NAME,
        REG.AGENCY_NAME,
        DTL.RATIO,
        DTL.ITEM_NAME,
        MSPR.D_MONTH,
        DTL.TOTAL_NO_BAGS,
        MSPR.POLICY_CODE,
        DTL.TOTAL_ADDITIONAL_RATIO,
        MSPR.DEAL_DATE
) FINAL_RESULT;
