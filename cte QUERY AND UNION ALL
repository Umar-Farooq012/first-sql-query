WITH ORDER_BAGS AS (
    SELECT
        SOD.ITEM_ID,
        ITM.ITEM_NAME,
        NVL(SUM(SOD.NO_BAGS), 0) AS ORDER_BAGS
    FROM
        AB_SO_ORDER_HEAD HEAD
        JOIN AB_SO_ORDER_DET SOD ON SOD.SO_ID = HEAD.SO_ID
        JOIN AB_ITEMS_MASTER ITM ON ITM.ITEM_ID = SOD.ITEM_ID
    WHERE
        SOD.SOD_TYPE = 'SALE ORDER DET'
        AND SOD.ORG_ID = :GV_ORG_ID
    GROUP BY
        SOD.ITEM_ID,
        ITM.ITEM_NAME
),
-- Order Shipment CTE
ORDER_SHIPMENT AS (
    SELECT
        SOD.ITEM_ID,
        ITM.ITEM_NAME,
        NVL(SUM(SOD.NO_BAGS), 0) AS LIFT_BAGS
    FROM
        AB_SO_ORDER_HEAD HEAD
        JOIN AB_SO_ORDER_DET SOD ON SOD.SO_ID = HEAD.SO_ID
        JOIN AB_SO_ORDER_DET DET ON DET.SOD_IDS = SOD.SOD_ID
        JOIN AB_ITEMS_MASTER ITM ON ITM.ITEM_ID = SOD.ITEM_ID
    WHERE
        DET.SOD_TYPE = 'SO SHIPMENT DET'
        AND SOD.ORG_ID = :GV_ORG_ID
    GROUP BY
        SOD.ITEM_ID,
        ITM.ITEM_NAME
),
PARTY_NAME AS (
      SELECT
              POD.DET_ID GRND_ID,
              PO.ITEM_IDD ITEM_ID,
              POD.CO_TYPE PURCHASING_TYPE,
              ITM.ITEM_NAME ITEM_NAME, 
              ASR.PARTY_NAME--,
             
   FROM 
                  AB_PO_PURCHASE_ORDER PO
        JOIN AB_ITEMS_MASTER ITM ON ITM.ITEM_ID = PO.ITEM_IDD
        JOIN AB_PO_PURCHASE_ORDER_DET POD  ON POD.PO_ID = PO.PO_ID
        JOIN AB_SETUP_REGISTRATION ASR ON ASR.SR_ID IN(POD.CO_AGENCY_ID,POD.CO_VENDOR_ID,POD.WAREHOUSE_ID)
    WHERE 
                    PO.PO_TYPE = 'OPENING PRODUCT'
                  AND  ASR.REG_TYPE IN  ('VENDOR', 'DEALER')
            AND  PO.ORG_ID = :GV_ORG_ID
),
-- Main Stock Query
STOCK_DATA AS (
    SELECT 
        ITEM_ID,
        ITEM_NAME,
        SUM(OPENING_BAGS) OPENING_BAGS,
        SUM(GRN_BAGS) GRN_BAGS,
        SUM(AMANAT_BAGS) AMANAT_BAGS,
        (NVL(SUM(OPENING_BAGS), 0) + NVL(SUM(GRN_BAGS), 0) + NVL(SUM(AMANAT_BAGS), 0)) AS TOTAL_AVAILABLE_STOCK,
        SUM(PENDING_BAGS) PENDING_BAGS,
        SUM(DUMPING_BAGS) DUMPING_BAGS,
        SUM(TRADE_BAGS) TRADE_BAGS
    FROM (
        SELECT 
            ITEM_ID, ITEM_NAME, SUM(OPENING_BAGS) OPENING_BAGS, 0 GRN_BAGS, 0 AMANAT_BAGS, 0 PENDING_BAGS, 0 DUMPING_BAGS, 0 TRADE_BAGS 
        FROM TABLE(AB_GENERAL_PACKAGE.OPENING_STOCK(:GV_ORG_ID)) 
        GROUP BY ITEM_ID, ITEM_NAME
        UNION ALL
        SELECT 
            ITEM_ID, ITEM_NAME, 0 OPENING_BAGS, SUM(GRN_BAGS) GRN_BAGS, 0 AMANAT_BAGS, 0 PENDING_BAGS, 0 DUMPING_BAGS, 0 TRADE_BAGS 
        FROM TABLE(AB_GENERAL_PACKAGE.GRN_STOCK(:GV_ORG_ID)) 
        GROUP BY ITEM_ID, ITEM_NAME
        UNION ALL
        SELECT 
            ITEM_ID, ITEM_NAME, 0 OPENING_BAGS, 0 GRN_BAGS, SUM(AMANAT_BAGS) AMANAT_BAGS, 0 PENDING_BAGS, 0 DUMPING_BAGS, 0 TRADE_BAGS 
        FROM TABLE(AB_GENERAL_PACKAGE.AMANAT_STOCK(:GV_ORG_ID)) 
        GROUP BY ITEM_ID, ITEM_NAME
        UNION ALL
        SELECT 
            ITEM_ID, ITEM_NAME, 0 OPENING_BAGS, 0 GRN_BAGS, 0 AMANAT_BAGS, PENDING_BAGS, 0 DUMPING_BAGS, 0 TRADE_BAGS 
        FROM TABLE(AB_GENERAL_PACKAGE.PENDING_PO(:GV_ORG_ID))
        UNION ALL
        SELECT 
            ITEM_ID, ITEM_NAME, 0 OPENING_BAGS, 0 GRN_BAGS, 0 AMANAT_BAGS, 0 PENDING_BAGS, DUMPING_BAGS, 0 TRADE_BAGS 
        FROM TABLE(AB_GENERAL_PACKAGE.DUMP_STOCK(:GV_ORG_ID))
    ) 
    GROUP BY ITEM_ID, ITEM_NAME
)
-- Final Query Combining Stock and Order Data
SELECT 
    SD.ITEM_ID,
    SD.ITEM_NAME,
    SD.OPENING_BAGS,
    SD.GRN_BAGS,
    SD.AMANAT_BAGS,
    SD.TOTAL_AVAILABLE_STOCK,
    SD.PENDING_BAGS,
    SD.DUMPING_BAGS,
    SD.TRADE_BAGS,
    PN.PARTY_NAME,
    NVL(OB.ORDER_BAGS, 0) AS ORDER_BAGS,
    NVL(OS.LIFT_BAGS, 0) AS LIFT_BAGS,
    NVL(OB.ORDER_BAGS, 0) - NVL(OS.LIFT_BAGS, 0) AS UNLIFT_BAGS
FROM 
    STOCK_DATA SD
    LEFT JOIN ORDER_BAGS OB ON SD.ITEM_ID = OB.ITEM_ID
    LEFT JOIN ORDER_SHIPMENT OS ON SD.ITEM_ID = OS.ITEM_ID
    LEFT JOIN PARTY_NAME PN ON PN.ITEM_ID = SD.ITEM_ID
ORDER BY 
    SD.ITEM_ID ASC;
